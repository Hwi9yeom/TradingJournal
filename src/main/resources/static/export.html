<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이터 내보내기 - Trading Journal</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Styles -->
    <link rel="stylesheet" href="css/dashboard-glass.css">
    <style>
        .export-card {
            cursor: pointer;
            position: relative;
        }
        .export-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.45);
        }
        .export-icon {
            font-size: 3rem;
        }
        .format-badge {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }
        .format-badge.excel {
            background: rgba(0, 245, 160, 0.15);
            color: var(--color-positive);
            border: 1px solid rgba(0, 245, 160, 0.3);
        }
        .format-badge.csv {
            background: var(--glass-bg-hover);
            color: var(--text-secondary);
            border: 1px solid var(--glass-border);
        }
        .format-badge.pdf {
            background: rgba(255, 107, 107, 0.15);
            color: var(--color-negative);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .format-badge.primary {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-mid));
            color: var(--text-primary);
            border: none;
            box-shadow: 0 2px 10px var(--color-accent-glow);
        }
        .export-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }
        @media (max-width: 1200px) {
            .export-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 768px) {
            .export-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Background Orbs -->
    <div class="bg-orb bg-orb-1"></div>
    <div class="bg-orb bg-orb-2"></div>
    <div class="bg-orb bg-orb-3"></div>

    <!-- Navigation -->
    <nav class="navbar-glass">
        <div class="container">
            <a href="index.html" class="navbar-brand">
                <span class="logo-icon"><i class="bi bi-graph-up-arrow"></i></span>
                Trading Journal
            </a>
            <ul class="navbar-nav">
                <li><a href="dashboard.html" class="nav-link"><i class="bi bi-speedometer2"></i> 대시보드</a></li>
                <li><a href="index.html" class="nav-link"><i class="bi bi-list-ul"></i> 거래관리</a></li>
                <li><a href="risk.html" class="nav-link"><i class="bi bi-shield-check"></i> 리스크</a></li>
                <li><a href="goals.html" class="nav-link"><i class="bi bi-bullseye"></i> 목표관리</a></li>
                <li><a href="alerts.html" class="nav-link"><i class="bi bi-bell"></i> 알림</a></li>
                <li><a href="export.html" class="nav-link active"><i class="bi bi-download"></i> 내보내기</a></li>
                <li><a href="#" class="nav-link" onclick="logout()"><i class="bi bi-box-arrow-right"></i></a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Page Header -->
        <header class="page-header fade-in">
            <div class="page-title">
                <h1><i class="bi bi-download"></i> 데이터 내보내기</h1>
                <span class="subtitle">거래 내역 및 분석 데이터를 다양한 형식으로 내보내기</span>
            </div>
        </header>

        <!-- 기간 선택 -->
        <section class="glass-card mb-8 fade-in">
            <div class="glass-card-header">
                <h3><i class="bi bi-calendar3"></i> 기간 설정</h3>
            </div>
            <div class="glass-card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-4); align-items: end;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="startDate" class="form-label">시작일</label>
                        <input type="date" class="form-input" id="startDate">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="endDate" class="form-label">종료일</label>
                        <input type="date" class="form-input" id="endDate">
                    </div>
                    <div style="grid-column: span 2;">
                        <div class="period-selector">
                            <button type="button" class="period-btn" onclick="setDateRange('1m')">1개월</button>
                            <button type="button" class="period-btn" onclick="setDateRange('3m')">3개월</button>
                            <button type="button" class="period-btn" onclick="setDateRange('6m')">6개월</button>
                            <button type="button" class="period-btn active" onclick="setDateRange('1y')">1년</button>
                            <button type="button" class="period-btn" onclick="setDateRange('all')">전체</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 내보내기 옵션 카드 -->
        <section class="export-grid fade-in">
            <!-- 거래 내역 Excel -->
            <div class="glass-card export-card" onclick="exportData('transactions', 'excel')">
                <span class="format-badge excel">Excel</span>
                <div class="glass-card-body" style="text-align: center; padding: var(--space-8);">
                    <i class="bi bi-file-earmark-spreadsheet export-icon text-positive" style="display: block; margin-bottom: var(--space-4);"></i>
                    <h5 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-2);">거래 내역</h5>
                    <p style="color: var(--text-muted); font-size: var(--font-size-sm);">
                        모든 매수/매도 거래 기록을<br>Excel 파일로 다운로드
                    </p>
                </div>
            </div>

            <!-- 거래 내역 CSV -->
            <div class="glass-card export-card" onclick="exportData('transactions', 'csv')">
                <span class="format-badge csv">CSV</span>
                <div class="glass-card-body" style="text-align: center; padding: var(--space-8);">
                    <i class="bi bi-file-earmark-text export-icon text-secondary" style="display: block; margin-bottom: var(--space-4);"></i>
                    <h5 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-2);">거래 내역</h5>
                    <p style="color: var(--text-muted); font-size: var(--font-size-sm);">
                        모든 매수/매도 거래 기록을<br>CSV 파일로 다운로드
                    </p>
                </div>
            </div>

            <!-- 포트폴리오 분석 -->
            <div class="glass-card export-card" onclick="exportData('portfolio', 'excel')">
                <span class="format-badge excel">Excel</span>
                <div class="glass-card-body" style="text-align: center; padding: var(--space-8);">
                    <i class="bi bi-pie-chart export-icon" style="display: block; margin-bottom: var(--space-4); color: var(--gradient-start);"></i>
                    <h5 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-2);">포트폴리오 분석</h5>
                    <p style="color: var(--text-muted); font-size: var(--font-size-sm);">
                        보유 종목, 수익률, 손익 분석<br>데이터를 Excel로 다운로드
                    </p>
                </div>
            </div>

            <!-- 목표 현황 -->
            <div class="glass-card export-card" onclick="exportData('goals', 'excel')">
                <span class="format-badge excel">Excel</span>
                <div class="glass-card-body" style="text-align: center; padding: var(--space-8);">
                    <i class="bi bi-bullseye export-icon text-warning" style="display: block; margin-bottom: var(--space-4);"></i>
                    <h5 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-2);">목표 현황</h5>
                    <p style="color: var(--text-muted); font-size: var(--font-size-sm);">
                        설정된 모든 목표와<br>진행 상황을 Excel로 다운로드
                    </p>
                </div>
            </div>

            <!-- 종합 리포트 -->
            <div class="glass-card export-card" onclick="exportData('full-report', 'excel')" style="border-color: var(--gradient-start);">
                <span class="format-badge primary">종합</span>
                <div class="glass-card-body" style="text-align: center; padding: var(--space-8);">
                    <i class="bi bi-file-earmark-richtext export-icon" style="display: block; margin-bottom: var(--space-4); color: var(--gradient-start);"></i>
                    <h5 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-2);">종합 리포트</h5>
                    <p style="color: var(--text-muted); font-size: var(--font-size-sm);">
                        모든 데이터를 포함한<br>종합 Excel 리포트 다운로드
                    </p>
                </div>
            </div>

            <!-- PDF 리포트 링크 -->
            <div class="glass-card export-card" onclick="window.location.href='report.html'">
                <span class="format-badge pdf">PDF</span>
                <div class="glass-card-body" style="text-align: center; padding: var(--space-8);">
                    <i class="bi bi-file-earmark-pdf export-icon text-negative" style="display: block; margin-bottom: var(--space-4);"></i>
                    <h5 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-2);">PDF 리포트</h5>
                    <p style="color: var(--text-muted); font-size: var(--font-size-sm);">
                        차트가 포함된 시각적<br>PDF 리포트 생성
                    </p>
                </div>
            </div>
        </section>

        <!-- 안내 문구 -->
        <div class="alert-glass" style="border-left: 3px solid var(--color-info); background: rgba(107, 202, 255, 0.05);">
            <i class="bi bi-info-circle alert-icon" style="color: var(--color-info);"></i>
            <div class="alert-content">
                <div class="alert-title">안내</div>
                <div class="alert-message">
                    Excel 파일은 Microsoft Excel, Google Sheets, LibreOffice 등에서 열 수 있습니다.
                    CSV 파일은 대부분의 스프레드시트 프로그램과 데이터 분석 도구에서 사용 가능합니다.
                </div>
            </div>
        </div>
    </main>

    <!-- 로딩 모달 -->
    <div class="modal-glass" id="loadingModal">
        <div class="modal-glass-content" style="max-width: 400px;">
            <div class="modal-body" style="text-align: center; padding: var(--space-8);">
                <div class="spinner" style="margin: 0 auto var(--space-5);"></div>
                <p style="font-size: var(--font-size-base); color: var(--text-primary); margin: 0;">파일을 생성하는 중...</p>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="utils.js"></script>
    <script src="auth.js"></script>
    <script src="js/glass-utils.js"></script>
    <script>
        // 페이지 로드 시 기본 날짜 설정
        $(document).ready(function() {
            setDateRange('1y');
        });

        /**
         * 기간 설정
         */
        function setDateRange(range) {
            const today = new Date();
            let startDate = new Date();

            switch(range) {
                case '1m':
                    startDate.setMonth(today.getMonth() - 1);
                    break;
                case '3m':
                    startDate.setMonth(today.getMonth() - 3);
                    break;
                case '6m':
                    startDate.setMonth(today.getMonth() - 6);
                    break;
                case '1y':
                    startDate.setFullYear(today.getFullYear() - 1);
                    break;
                case 'all':
                    startDate = null;
                    break;
            }

            if (startDate) {
                $('#startDate').val(formatDate(startDate));
            } else {
                $('#startDate').val('');
            }
            $('#endDate').val(formatDate(today));

            // 버튼 활성화 상태 업데이트
            $('.period-selector .period-btn').removeClass('active');
            $(`.period-selector .period-btn[onclick*="${range}"]`).addClass('active');
        }

        /**
         * 날짜 포맷
         */
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        /**
         * 데이터 내보내기
         */
        function exportData(type, format) {
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();

            let url = `/api/export/${type}/${format}`;

            // 쿼리 파라미터 추가
            const params = [];
            if (startDate) params.push(`startDate=${startDate}`);
            if (endDate) params.push(`endDate=${endDate}`);
            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            // 로딩 모달 표시
            openGlassModal('loadingModal');

            // 파일 다운로드
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('다운로드 실패');
                    }
                    return response.blob();
                })
                .then(blob => {
                    // Content-Disposition 헤더에서 파일명 추출
                    const filename = getFilename(type, format);

                    // 다운로드 링크 생성
                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    closeGlassModal('loadingModal');
                    showGlassToast('파일이 다운로드되었습니다.', 'success');
                })
                .catch(error => {
                    console.error('다운로드 오류:', error);
                    closeGlassModal('loadingModal');
                    showGlassToast('다운로드에 실패했습니다.', 'error');
                });
        }

        /**
         * 파일명 생성
         */
        function getFilename(type, format) {
            const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
            const extension = format === 'excel' ? 'xlsx' : 'csv';

            const names = {
                'transactions': '거래내역',
                'portfolio': '포트폴리오분석',
                'goals': '목표현황',
                'full-report': '종합리포트'
            };

            return `${names[type] || type}_${date}.${extension}`;
        }

        // showGlassToast function is provided by glass-utils.js
    </script>
</body>
</html>
