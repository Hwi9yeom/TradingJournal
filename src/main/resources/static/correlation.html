<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상관관계 분석 - Trading Journal</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="css/dashboard-glass.css">
    <style>
        .correlation-cell {
            width: 50px;
            height: 50px;
            text-align: center;
            vertical-align: middle;
            font-size: var(--font-size-xs);
            font-weight: 500;
            cursor: pointer;
            transition: transform var(--transition-base), box-shadow var(--transition-base);
            border: 1px solid var(--glass-border);
        }
        .correlation-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
            z-index: 10;
            position: relative;
        }
        .correlation-header {
            font-size: var(--font-size-xs);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60px;
            color: var(--text-secondary);
        }
        .pair-analysis {
            display: none;
        }
        .pair-analysis.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        .recommendation-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-bottom: var(--space-3);
            transition: var(--transition-base);
            cursor: pointer;
        }
        .recommendation-card:hover {
            background: var(--glass-bg-hover);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Background Orbs -->
    <div class="bg-orb bg-orb-1"></div>
    <div class="bg-orb bg-orb-2"></div>
    <div class="bg-orb bg-orb-3"></div>

    <!-- Navigation -->
    <nav class="navbar-glass">
        <div class="container">
            <a href="index.html" class="navbar-brand">
                <span class="logo-icon"><i class="bi bi-graph-up-arrow"></i></span>
                Trading Journal
            </a>
            <ul class="navbar-nav">
                <li><a href="dashboard.html" class="nav-link"><i class="bi bi-speedometer2"></i> 대시보드</a></li>
                <li><a href="index.html" class="nav-link"><i class="bi bi-list-ul"></i> 거래관리</a></li>
                <li><a href="risk.html" class="nav-link"><i class="bi bi-shield-check"></i> 리스크</a></li>
                <li><a href="plans.html" class="nav-link"><i class="bi bi-journal-bookmark"></i> 트레이드플랜</a></li>
                <li><a href="correlation.html" class="nav-link active"><i class="bi bi-grid-3x3"></i> 상관관계</a></li>
                <li><a href="dividend.html" class="nav-link"><i class="bi bi-cash-coin"></i> 배당금</a></li>
                <li><a href="ai-assistant.html" class="nav-link"><i class="bi bi-robot"></i> AI</a></li>
                <li><a href="accounts.html" class="nav-link"><i class="bi bi-wallet2"></i> 계좌</a></li>
                <li><a href="#" class="nav-link" onclick="logout()"><i class="bi bi-box-arrow-right"></i></a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Page Header -->
        <header class="page-header fade-in">
            <div class="page-title">
                <h1>상관관계 분석</h1>
                <span class="subtitle">종목 간 상관관계 분석 및 분산투자 전략</span>
            </div>
            <div>
                <select class="select-glass" id="period-selector">
                    <option value="3M">최근 3개월</option>
                    <option value="6M" selected>최근 6개월</option>
                    <option value="1Y">최근 1년</option>
                    <option value="ALL">전체 기간</option>
                </select>
            </div>
        </header>

        <!-- Summary Stats -->
        <section class="stats-grid fade-in">
            <div class="stat-card stagger-1">
                <div class="stat-card-header">
                    <span class="stat-card-label">평균 상관계수</span>
                    <div class="stat-card-icon">
                        <i class="bi bi-percent"></i>
                    </div>
                </div>
                <div class="stat-card-value" id="avg-correlation">-</div>
                <div class="stat-card-change">
                    <i class="bi bi-graph-up"></i>
                    종목 간 평균 상관성
                </div>
            </div>
            <div class="stat-card stagger-2">
                <div class="stat-card-header">
                    <span class="stat-card-label">분산투자 점수</span>
                    <div class="stat-card-icon">
                        <i class="bi bi-star"></i>
                    </div>
                </div>
                <div class="stat-card-value" id="diversification-score">-</div>
                <div class="stat-card-change">
                    <i class="bi bi-shield-check"></i>
                    포트폴리오 다각화
                </div>
            </div>
            <div class="stat-card stagger-3">
                <div class="stat-card-header">
                    <span class="stat-card-label">분석 종목 수</span>
                    <div class="stat-card-icon">
                        <i class="bi bi-bar-chart"></i>
                    </div>
                </div>
                <div class="stat-card-value" id="stock-count">-</div>
                <div class="stat-card-change">
                    <i class="bi bi-briefcase"></i>
                    보유 종목
                </div>
            </div>
            <div class="stat-card stagger-4">
                <div class="stat-card-header">
                    <span class="stat-card-label">분석 기간</span>
                    <div class="stat-card-icon">
                        <i class="bi bi-calendar-range"></i>
                    </div>
                </div>
                <div class="stat-card-value" id="analysis-period-display">6개월</div>
                <div class="stat-card-change">
                    <i class="bi bi-clock-history"></i>
                    선택된 기간
                </div>
            </div>
        </section>

        <!-- Correlation Heatmap -->
        <section class="glass-card mb-8 fade-in">
            <div class="glass-card-header">
                <h3><i class="bi bi-grid-3x3"></i> 상관관계 히트맵</h3>
                <div class="legend-row">
                    <div class="legend-item">
                        <span class="legend-color" style="background: #22c55e;"></span>
                        <small>-1.0 (역상관)</small>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #fbbf24;"></span>
                        <small>0 (무관)</small>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #ef4444;"></span>
                        <small>+1.0 (정상관)</small>
                    </div>
                </div>
            </div>
            <div class="glass-card-body">
                <div class="alert-glass" style="margin-bottom: var(--space-5);">
                    <i class="bi bi-info-circle alert-icon" style="color: var(--color-info);"></i>
                    <div class="alert-content">
                        <p class="alert-message" style="color: var(--text-secondary);">
                            셀을 클릭하면 두 종목 간 상세 분석을 볼 수 있습니다.
                        </p>
                    </div>
                </div>
                <div class="correlation-container">
                    <table class="glass-table" id="heatmap-table">
                        <thead id="heatmap-header"></thead>
                        <tbody id="heatmap-body"></tbody>
                    </table>
                </div>
                <div id="heatmap-empty" class="empty-state" style="display: none;">
                    <i class="bi bi-inbox empty-state-icon"></i>
                    <h3 class="empty-state-title">분석할 종목이 없습니다</h3>
                    <p class="empty-state-desc">거래를 추가하여 상관관계를 분석하세요.</p>
                </div>
            </div>
        </section>

        <!-- Sector Analysis & Recommendations -->
        <section class="two-col-grid mb-8">
            <div class="glass-card fade-in">
                <div class="glass-card-header">
                    <h3><i class="bi bi-pie-chart"></i> 섹터별 상관관계</h3>
                </div>
                <div class="glass-card-body">
                    <div id="sector-summary">
                        <div class="empty-state">
                            <div class="spinner"></div>
                            <p class="empty-state-desc" style="margin-top: var(--space-4);">로딩 중...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="glass-card fade-in">
                <div class="glass-card-header">
                    <h3><i class="bi bi-lightbulb"></i> 분산투자 추천</h3>
                </div>
                <div class="glass-card-body">
                    <p class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--space-4);">
                        상관관계가 낮은 종목 쌍입니다.
                    </p>
                    <div id="recommendations">
                        <div class="empty-state">
                            <div class="spinner"></div>
                            <p class="empty-state-desc" style="margin-top: var(--space-4);">로딩 중...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pair Analysis Detail -->
        <section class="glass-card mb-8 pair-analysis" id="pair-analysis-card">
            <div class="glass-card-header">
                <h3>
                    <i class="bi bi-graph-up"></i>
                    <span id="pair-title">종목 쌍 상세 분석</span>
                </h3>
                <button class="btn-glass" onclick="closePairAnalysis()">
                    <i class="bi bi-x-lg"></i> 닫기
                </button>
            </div>
            <div class="glass-card-body">
                <!-- Pair Summary -->
                <div class="stats-row" style="margin-bottom: var(--space-8);">
                    <div class="stats-row-item">
                        <label>현재 상관계수</label>
                        <div class="value" id="pair-correlation">-</div>
                    </div>
                    <div class="stats-row-item">
                        <label>분산투자 효과</label>
                        <div class="value" id="pair-benefit">-</div>
                    </div>
                    <div class="stats-row-item">
                        <label id="pair-label1">종목1 평균수익</label>
                        <div class="value" id="pair-avg-return1">-</div>
                    </div>
                    <div class="stats-row-item">
                        <label id="pair-label2">종목2 평균수익</label>
                        <div class="value" id="pair-avg-return2">-</div>
                    </div>
                    <div class="stats-row-item">
                        <label>종목1 변동성</label>
                        <div class="value" id="pair-vol1">-</div>
                    </div>
                    <div class="stats-row-item">
                        <label>종목2 변동성</label>
                        <div class="value" id="pair-vol2">-</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="two-col-grid" style="margin-bottom: var(--space-6);">
                    <div>
                        <h6 class="text-center" style="margin-bottom: var(--space-4); color: var(--text-secondary);">
                            롤링 상관관계 (30일 윈도우)
                        </h6>
                        <div class="chart-container">
                            <canvas id="rolling-chart" height="250"></canvas>
                        </div>
                    </div>
                    <div>
                        <h6 class="text-center" style="margin-bottom: var(--space-4); color: var(--text-secondary);">
                            누적 수익률 비교
                        </h6>
                        <div class="chart-container">
                            <canvas id="comparison-chart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Rolling Correlation Stats -->
                <div class="alert-glass" style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3);">
                    <div class="stats-row" style="gap: var(--space-6);">
                        <div class="stats-row-item">
                            <label>평균</label>
                            <div class="value" id="rolling-avg" style="color: var(--color-info);">-</div>
                        </div>
                        <div class="stats-row-item">
                            <label>최고</label>
                            <div class="value" id="rolling-max" style="color: var(--color-positive);">-</div>
                        </div>
                        <div class="stats-row-item">
                            <label>최저</label>
                            <div class="value" id="rolling-min" style="color: var(--color-negative);">-</div>
                        </div>
                        <div class="stats-row-item">
                            <label>변동성</label>
                            <div class="value" id="rolling-vol" style="color: var(--color-warning);">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="utils.js"></script>
    <script src="auth.js"></script>
    <script src="js/glass-utils.js"></script>
    <script src="correlation.js"></script>
    <script>
        // Update period display when selector changes
        document.getElementById('period-selector')?.addEventListener('change', function() {
            const periodMap = {
                '3M': '3개월',
                '6M': '6개월',
                '1Y': '1년',
                'ALL': '전체'
            };
            const display = document.getElementById('analysis-period-display');
            if (display) {
                display.textContent = periodMap[this.value] || this.value;
            }
        });
    </script>
</body>
</html>
