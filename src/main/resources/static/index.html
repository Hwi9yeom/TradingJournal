<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>거래관리 - Trading Journal</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="css/dashboard-glass.css">
</head>
<body>
    <!-- Background Orbs -->
    <div class="bg-orb bg-orb-1"></div>
    <div class="bg-orb bg-orb-2"></div>
    <div class="bg-orb bg-orb-3"></div>

    <!-- Navigation -->
    <nav class="navbar-glass">
        <div class="container">
            <a href="index.html" class="navbar-brand">
                <span class="logo-icon"><i class="bi bi-graph-up-arrow"></i></span>
                Trading Journal
            </a>
            <ul class="navbar-nav">
                <li><a href="dashboard.html" class="nav-link"><i class="bi bi-speedometer2"></i> 대시보드</a></li>
                <li><a href="index.html" class="nav-link active"><i class="bi bi-list-ul"></i> 거래관리</a></li>
                <li><a href="risk.html" class="nav-link"><i class="bi bi-shield-check"></i> 리스크</a></li>
                <li><a href="plans.html" class="nav-link"><i class="bi bi-journal-bookmark"></i> 트레이드플랜</a></li>
                <li><a href="correlation.html" class="nav-link"><i class="bi bi-grid-3x3"></i> 상관관계</a></li>
                <li><a href="dividend.html" class="nav-link"><i class="bi bi-cash-coin"></i> 배당금</a></li>
                <li><a href="ai-assistant.html" class="nav-link"><i class="bi bi-robot"></i> AI</a></li>
                <li><a href="accounts.html" class="nav-link"><i class="bi bi-wallet2"></i> 계좌</a></li>
                <li><a href="#" class="nav-link" onclick="logout()"><i class="bi bi-box-arrow-right"></i></a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Page Header -->
        <header class="page-header fade-in">
            <div class="page-title">
                <h1>거래 관리</h1>
                <span class="subtitle">포트폴리오 및 거래 내역 관리</span>
            </div>
            <div style="display: flex; align-items: center; gap: var(--space-3);">
                <label class="text-muted" style="font-size: var(--font-size-sm);">계좌:</label>
                <select class="select-glass" id="account-selector" style="min-width: 150px;">
                    <option value="">전체 계좌</option>
                </select>
            </div>
        </header>

        <!-- Portfolio Summary Stats -->
        <section class="stats-grid fade-in">
            <div class="stat-card stagger-1">
                <div class="stat-card-header">
                    <span class="stat-card-label">총 투자금액</span>
                    <div class="stat-card-icon">
                        <i class="bi bi-cash-stack"></i>
                    </div>
                </div>
                <div class="stat-card-value" id="total-investment">₩0</div>
                <div class="stat-card-change">
                    <i class="bi bi-wallet2"></i>
                    투자 원금
                </div>
            </div>
            <div class="stat-card stagger-2">
                <div class="stat-card-header">
                    <span class="stat-card-label">현재 가치</span>
                    <div class="stat-card-icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                </div>
                <div class="stat-card-value" id="total-value">₩0</div>
                <div class="stat-card-change">
                    <i class="bi bi-bar-chart"></i>
                    평가금액
                </div>
            </div>
            <div class="stat-card stagger-3" id="profit-card">
                <div class="stat-card-header">
                    <span class="stat-card-label">누적 수익률</span>
                    <div class="stat-card-icon">
                        <i class="bi bi-percent"></i>
                    </div>
                </div>
                <div class="stat-card-value" id="total-profit">0%</div>
                <div class="stat-card-change">
                    <i class="bi bi-graph-up-arrow"></i>
                    총 수익
                </div>
            </div>
            <div class="stat-card stagger-4" id="day-change-card">
                <div class="stat-card-header">
                    <span class="stat-card-label">오늘 수익률</span>
                    <div class="stat-card-icon">
                        <i class="bi bi-clock-history"></i>
                    </div>
                </div>
                <div class="stat-card-value" id="day-change">0%</div>
                <div class="stat-card-change">
                    <i class="bi bi-calendar-day"></i>
                    일간 변동
                </div>
            </div>
        </section>

        <!-- Transaction Form -->
        <section class="glass-card mb-8 fade-in">
            <div class="glass-card-header">
                <h3><i class="bi bi-plus-circle"></i> 거래 추가</h3>
                <div style="display: flex; gap: var(--space-2);">
                    <button class="btn-glass" onclick="openGlassModal('importModal')">
                        <i class="bi bi-upload"></i> 가져오기
                    </button>
                    <div class="dropdown-glass" id="exportDropdown">
                        <button class="btn-glass" onclick="toggleDropdown('exportDropdown')">
                            <i class="bi bi-download"></i> 내보내기
                            <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu">
                            <a href="#" class="dropdown-item" onclick="exportData('csv')">
                                <i class="bi bi-filetype-csv"></i> CSV로 내보내기
                            </a>
                            <a href="#" class="dropdown-item" onclick="exportData('excel')">
                                <i class="bi bi-file-earmark-excel"></i> Excel로 내보내기
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="glass-card-body">
                <form id="transaction-form">
                    <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--space-4);">
                        <div class="form-group">
                            <label class="form-label" for="transaction-account">계좌</label>
                            <select class="select-glass" id="transaction-account" required aria-required="true">
                                <!-- 동적으로 채워짐 -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="stock-symbol">종목 코드</label>
                            <input type="text" class="form-input" id="stock-symbol" required aria-required="true" placeholder="예: AAPL">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="transaction-type">유형</label>
                            <select class="select-glass" id="transaction-type" required aria-required="true">
                                <option value="BUY">매수</option>
                                <option value="SELL">매도</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="quantity">수량</label>
                            <input type="number" class="form-input" id="quantity" step="0.01" required aria-required="true" min="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="price">가격</label>
                            <input type="number" class="form-input" id="price" step="0.01" required aria-required="true" min="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="commission">수수료</label>
                            <input type="number" class="form-input" id="commission" step="0.01" value="0" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="transaction-date">거래일시</label>
                            <input type="datetime-local" class="form-input" id="transaction-date" required aria-required="true">
                        </div>
                    </div>
                    <div style="margin-top: var(--space-5);">
                        <button type="submit" class="btn-glass primary" aria-label="거래 추가">
                            <i class="bi bi-plus-circle"></i> 거래 추가
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Portfolio Charts -->
        <section class="charts-grid mb-8">
            <div class="glass-card fade-in">
                <div class="glass-card-header">
                    <h3><i class="bi bi-pie-chart"></i> 포트폴리오 구성</h3>
                </div>
                <div class="glass-card-body">
                    <div class="chart-container">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="glass-card fade-in">
                <div class="glass-card-header">
                    <h3><i class="bi bi-graph-up-arrow"></i> 수익률 추이</h3>
                </div>
                <div class="glass-card-body">
                    <div class="chart-container">
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Heatmap -->
        <section class="glass-card mb-8 fade-in">
            <div class="glass-card-header">
                <h3><i class="bi bi-calendar3"></i> 일별 수익률 히트맵</h3>
            </div>
            <div class="glass-card-body">
                <div class="chart-container" style="height: 200px;">
                    <canvas id="heatmapChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Holdings Table -->
        <section class="glass-card mb-8 fade-in">
            <div class="glass-card-header">
                <h3><i class="bi bi-briefcase"></i> 보유 종목</h3>
            </div>
            <div class="glass-card-body">
                <div class="two-col-grid" style="grid-template-columns: 2fr 1fr;">
                    <div style="overflow-x: auto;">
                        <table class="glass-table">
                            <thead>
                                <tr>
                                    <th>종목명</th>
                                    <th class="text-right">보유수량</th>
                                    <th class="text-right">평균단가</th>
                                    <th class="text-right">현재가</th>
                                    <th class="text-right">평가금액</th>
                                    <th class="text-right">수익률</th>
                                    <th class="text-right">오늘 변동</th>
                                </tr>
                            </thead>
                            <tbody id="portfolio-holdings">
                            </tbody>
                        </table>
                    </div>
                    <div class="chart-container">
                        <canvas id="portfolioPieChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Analysis Section -->
        <section class="glass-card mb-8 fade-in">
            <div class="glass-card-header">
                <h3><i class="bi bi-bar-chart-line"></i> 분석</h3>
            </div>
            <div class="glass-card-body">
                <!-- Tab Navigation -->
                <div class="tab-nav" id="analysisTab" role="tablist">
                    <button class="tab-btn active" id="period-tab" data-target="period" onclick="switchTab('period', 'analysisTab')">
                        <i class="bi bi-calendar-range"></i> 기간별 분석
                    </button>
                    <button class="tab-btn" id="stock-tab" data-target="stock" onclick="switchTab('stock', 'analysisTab')">
                        <i class="bi bi-graph-up"></i> 종목별 분석
                    </button>
                    <button class="tab-btn" id="tax-tab" data-target="tax" onclick="switchTab('tax', 'analysisTab')">
                        <i class="bi bi-receipt"></i> 세금 계산
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content" id="analysisTabContent">
                    <div class="tab-pane active" id="period" role="tabpanel">
                        <div style="display: flex; gap: var(--space-3); align-items: flex-end; flex-wrap: wrap;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">시작일</label>
                                <input type="date" class="form-input" id="analysis-start-date">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">종료일</label>
                                <input type="date" class="form-input" id="analysis-end-date">
                            </div>
                            <button class="btn-glass primary" onclick="analyzePeriod()">
                                <i class="bi bi-search"></i> 분석
                            </button>
                        </div>
                        <div id="period-analysis-result" style="margin-top: var(--space-5);"></div>
                    </div>
                    <div class="tab-pane" id="stock" role="tabpanel">
                        <div style="display: flex; gap: var(--space-3); align-items: flex-end; flex-wrap: wrap;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">종목 코드</label>
                                <input type="text" class="form-input" id="analysis-stock-symbol" placeholder="종목 코드">
                            </div>
                            <button class="btn-glass primary" onclick="analyzeStock()">
                                <i class="bi bi-search"></i> 분석
                            </button>
                        </div>
                        <div id="stock-analysis-result" style="margin-top: var(--space-5);"></div>
                    </div>
                    <div class="tab-pane" id="tax" role="tabpanel">
                        <div style="display: flex; gap: var(--space-3); align-items: flex-end; flex-wrap: wrap;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">연도</label>
                                <select class="select-glass" id="tax-year">
                                    <option value="2024">2024년</option>
                                    <option value="2023">2023년</option>
                                    <option value="2022">2022년</option>
                                </select>
                            </div>
                            <button class="btn-glass primary" onclick="calculateTax()">
                                <i class="bi bi-calculator"></i> 계산
                            </button>
                        </div>
                        <div id="tax-calculation-result" style="margin-top: var(--space-5);"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Disclosure Section -->
        <section class="glass-card mb-8 fade-in">
            <div class="glass-card-header">
                <h3><i class="bi bi-newspaper"></i> 공시 정보</h3>
                <button class="btn-glass" onclick="syncDisclosures()">
                    <i class="bi bi-arrow-clockwise"></i> 공시 동기화
                </button>
            </div>
            <div class="glass-card-body">
                <!-- Disclosure Stats -->
                <div class="stats-row" style="margin-bottom: var(--space-6);">
                    <div class="stats-row-item">
                        <label>전체 공시</label>
                        <div class="value" id="total-disclosures">0</div>
                    </div>
                    <div class="stats-row-item">
                        <label>읽지 않은 공시</label>
                        <div class="value" style="color: var(--color-warning);" id="unread-disclosures">0</div>
                    </div>
                    <div class="stats-row-item">
                        <label>중요 공시</label>
                        <div class="value" style="color: var(--color-negative);" id="important-disclosures">0</div>
                    </div>
                </div>

                <!-- Disclosure Tabs -->
                <div class="tab-nav" id="disclosureTab" role="tablist">
                    <button class="tab-btn active" id="recent-disclosures-tab" data-target="recent-disclosures" onclick="switchTab('recent-disclosures', 'disclosureTab')">
                        <i class="bi bi-clock"></i> 최근 공시
                    </button>
                    <button class="tab-btn" id="unread-disclosures-tab" data-target="unread-disclosures-list" onclick="switchTab('unread-disclosures-list', 'disclosureTab')">
                        <i class="bi bi-envelope"></i> 읽지 않은 공시
                    </button>
                    <button class="tab-btn" id="important-disclosures-tab" data-target="important-disclosures-list" onclick="switchTab('important-disclosures-list', 'disclosureTab')">
                        <i class="bi bi-exclamation-triangle"></i> 중요 공시
                    </button>
                </div>

                <!-- Disclosure Tab Content -->
                <div class="tab-content" id="disclosureTabContent">
                    <div class="tab-pane active" id="recent-disclosures" role="tabpanel">
                        <div style="overflow-x: auto;">
                            <table class="glass-table">
                                <thead>
                                    <tr>
                                        <th>접수일</th>
                                        <th>종목</th>
                                        <th>보고서명</th>
                                        <th>제출인</th>
                                        <th>구분</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-disclosures-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane" id="unread-disclosures-list" role="tabpanel">
                        <div style="overflow-x: auto;">
                            <table class="glass-table">
                                <thead>
                                    <tr>
                                        <th>접수일</th>
                                        <th>종목</th>
                                        <th>보고서명</th>
                                        <th>제출인</th>
                                        <th>구분</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="unread-disclosures-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane" id="important-disclosures-list" role="tabpanel">
                        <div style="overflow-x: auto;">
                            <table class="glass-table">
                                <thead>
                                    <tr>
                                        <th>접수일</th>
                                        <th>종목</th>
                                        <th>보고서명</th>
                                        <th>제출인</th>
                                        <th>구분</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="important-disclosures-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Transaction History -->
        <section class="glass-card mb-8 fade-in">
            <div class="glass-card-header">
                <h3><i class="bi bi-clock-history"></i> 거래 내역</h3>
            </div>
            <div class="glass-card-body" style="padding: 0;">
                <div style="overflow-x: auto;">
                    <table class="glass-table">
                        <thead>
                            <tr>
                                <th>거래일시</th>
                                <th>종목명</th>
                                <th>거래유형</th>
                                <th class="text-right">수량</th>
                                <th class="text-right">가격</th>
                                <th class="text-right">거래금액</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-list">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Import Modal -->
    <div class="modal-glass" id="importModal">
        <div class="modal-glass-content">
            <div class="modal-header">
                <h3><i class="bi bi-upload"></i> 거래 내역 가져오기</h3>
                <button class="modal-close" onclick="closeGlassModal('importModal')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">파일 형식 선택</label>
                    <select class="select-glass" id="import-file-type">
                        <option value="csv">CSV 파일</option>
                        <option value="excel">Excel 파일 (.xlsx)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">파일 선택</label>
                    <input type="file" class="form-input" id="import-file" accept=".csv,.xlsx">
                </div>
                <div style="padding: var(--space-4); background: rgba(102, 126, 234, 0.1); border-radius: var(--radius-md); border: 1px solid rgba(102, 126, 234, 0.3);">
                    <div style="display: flex; align-items: flex-start; gap: var(--space-2); color: var(--color-info);">
                        <i class="bi bi-info-circle" style="margin-top: 2px;"></i>
                        <div style="font-size: var(--font-size-sm);">
                            <strong>파일 형식:</strong>
                            <ul style="margin: var(--space-2) 0 0 var(--space-4); padding: 0;">
                                <li>첫 번째 행은 헤더로 인식됩니다</li>
                                <li>컬럼 순서: 거래일시, 종목코드, 종목명, 거래구분(매수/매도), 수량, 단가, 금액, 수수료, 세금, 비고</li>
                                <li><a href="#" onclick="downloadTemplate()" style="color: var(--color-primary);">템플릿 다운로드</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="import-result" style="display: none; margin-top: var(--space-4);"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-glass" onclick="closeGlassModal('importModal')">취소</button>
                <button class="btn-glass primary" onclick="importData()">
                    <i class="bi bi-upload"></i> 가져오기
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="utils.js"></script>
    <script src="auth.js"></script>
    <script src="js/glass-utils.js"></script>
    <script src="app.js"></script>
    <script>
        // Tab switching function for glassmorphism tabs
        function switchTab(targetId, tabGroupId) {
            // Get tab group
            const tabNav = document.getElementById(tabGroupId);
            let tabContent = tabNav.nextElementSibling;
            while (tabContent && !tabContent.classList.contains('tab-content')) {
                tabContent = tabContent.nextElementSibling;
            }

            if (!tabContent) return;

            // Deactivate all tabs
            tabNav.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            tabContent.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

            // Activate target tab
            const targetBtn = tabNav.querySelector(`[data-target="${targetId}"]`);
            const targetPane = document.getElementById(targetId);

            if (targetBtn) targetBtn.classList.add('active');
            if (targetPane) targetPane.classList.add('active');
        }
    </script>
</body>
</html>
