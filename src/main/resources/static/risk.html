<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Management - Trading Journal</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="css/dashboard-glass.css">
</head>
<body>
    <!-- Background Orbs -->
    <div class="bg-orb bg-orb-1"></div>
    <div class="bg-orb bg-orb-2"></div>
    <div class="bg-orb bg-orb-3"></div>

    <!-- Navigation will be injected by navigation-glass.js -->

    <!-- Main Content -->
    <main class="main-container">
        <!-- Page Header -->
        <header class="page-header fade-in">
            <div class="page-title">
                <h1><i class="bi bi-shield-exclamation"></i> 리스크 관리</h1>
                <span class="subtitle">포지션 사이징 및 리스크 모니터링</span>
            </div>
            <button class="btn-glass primary" onclick="openGlassModal('settingsModal')">
                <i class="bi bi-gear"></i>설정
            </button>
        </header>

        <!-- 리스크 한도 상태 -->
        <section class="stats-grid fade-in stagger-1">
            <div class="stat-card" id="dailyLossCard">
                <div class="stat-card-header">
                    <span class="stat-card-label">일일 손실 한도</span>
                    <span class="risk-badge" id="dailyLossStatus">-</span>
                </div>
                <div class="stat-card-value" id="dailyPnl">₩0</div>
                <div class="progress-glass" style="margin-bottom: var(--space-2);">
                    <div class="progress-bar-glass" id="dailyLossProgress" style="width: 0%"></div>
                </div>
                <div class="stat-card-change" id="dailyLossRemaining">한도: -</div>
            </div>

            <div class="stat-card" id="weeklyLossCard">
                <div class="stat-card-header">
                    <span class="stat-card-label">주간 손실 한도</span>
                    <span class="risk-badge" id="weeklyLossStatus">-</span>
                </div>
                <div class="stat-card-value" id="weeklyPnl">₩0</div>
                <div class="progress-glass" style="margin-bottom: var(--space-2);">
                    <div class="progress-bar-glass" id="weeklyLossProgress" style="width: 0%"></div>
                </div>
                <div class="stat-card-change" id="weeklyLossRemaining">한도: -</div>
            </div>

            <div class="stat-card" id="positionCountCard">
                <div class="stat-card-header">
                    <span class="stat-card-label">오픈 포지션</span>
                    <span class="risk-badge" id="positionCountStatus">-</span>
                </div>
                <div class="stat-card-value" id="positionCount">0 / 10</div>
                <div class="progress-glass" style="margin-bottom: var(--space-2);">
                    <div class="progress-bar-glass" id="positionCountProgress" style="width: 0%"></div>
                </div>
                <div class="stat-card-change" id="positionCountRemaining">남은 슬롯: -</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-label">총 오픈 리스크</span>
                    <div class="stat-card-icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="stat-card-value" id="totalOpenRisk">₩0</div>
                <div class="stat-card-change">자본 대비 <span id="openRiskPercent">0%</span></div>
            </div>
        </section>

        <div class="two-col-grid">
            <!-- 포지션 사이징 계산기 -->
            <div>
                <div class="glass-card mb-4 fade-in stagger-2">
                    <div class="glass-card-header">
                        <h3><i class="bi bi-calculator"></i>포지션 사이징 계산기</h3>
                    </div>
                    <div class="glass-card-body">
                        <form id="positionSizingForm">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-4); margin-bottom: var(--space-4);">
                                <div class="form-group">
                                    <label class="form-label">진입가</label>
                                    <input type="number" class="form-input" id="entryPrice" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">손절가</label>
                                    <input type="number" class="form-input" id="stopLossPrice" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">익절가 (선택)</label>
                                    <input type="number" class="form-input" id="takeProfitPrice" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">리스크 %</label>
                                    <input type="number" class="form-input" id="riskPercent" value="2" step="0.1" min="0.1" max="10">
                                </div>
                            </div>
                            <button type="submit" class="btn-glass primary" style="width: 100%;">
                                <i class="bi bi-calculator"></i>계산하기
                            </button>
                        </form>

                        <!-- 계산 결과 -->
                        <div id="sizingResult" class="hidden" style="margin-top: var(--space-6);">
                            <div style="height: 1px; background: var(--glass-border); margin-bottom: var(--space-5);"></div>
                            <div class="metrics-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: var(--space-4);">
                                <div class="metric-card">
                                    <label>추천 수량</label>
                                    <div class="value text-positive" id="recommendedQty">0</div>
                                </div>
                                <div class="metric-card">
                                    <label>포지션 금액</label>
                                    <div class="value" id="positionValue">₩0</div>
                                </div>
                                <div class="metric-card">
                                    <label>R:R 비율</label>
                                    <div class="value" id="rrRatio">-</div>
                                </div>
                            </div>
                            <div style="background: rgba(0, 0, 0, 0.2); border-radius: var(--radius-lg); padding: var(--space-4); margin-bottom: var(--space-4);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-2);">
                                    <span>예상 손실:</span>
                                    <span class="text-negative font-mono" style="font-weight: 600;" id="potentialLoss">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>예상 이익:</span>
                                    <span class="text-positive font-mono" style="font-weight: 600;" id="potentialProfit">-</span>
                                </div>
                            </div>
                            <div style="color: var(--text-muted); font-size: var(--font-size-sm);" id="kellyInfo"></div>
                            <div class="alert-glass warning hidden" style="margin-top: var(--space-4);" id="sizingWarning"></div>
                        </div>
                    </div>
                </div>

                <!-- 시나리오 비교 -->
                <div class="glass-card hidden" id="scenariosCard">
                    <div class="glass-card-header">
                        <h3>리스크 수준별 시나리오</h3>
                    </div>
                    <div class="glass-card-body" style="padding: 0;">
                        <div style="overflow-x: auto;">
                            <table class="glass-table">
                                <thead>
                                    <tr>
                                        <th>시나리오</th>
                                        <th class="text-right">수량</th>
                                        <th class="text-right">금액</th>
                                        <th class="text-right">손실</th>
                                    </tr>
                                </thead>
                                <tbody id="scenariosBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- R-Multiple 분석 -->
            <div>
                <div class="glass-card mb-4 fade-in stagger-3">
                    <div class="glass-card-header">
                        <h3><i class="bi bi-graph-up"></i>R-Multiple 분석</h3>
                        <select class="select-glass" id="rMultiplePeriod" onchange="loadRMultipleAnalysis()">
                            <option value="1">최근 1개월</option>
                            <option value="3" selected>최근 3개월</option>
                            <option value="6">최근 6개월</option>
                            <option value="12">최근 1년</option>
                        </select>
                    </div>
                    <div class="glass-card-body">
                        <div class="metrics-grid" style="margin-bottom: var(--space-5);">
                            <div class="metric-card">
                                <label>평균 R</label>
                                <div class="value text-positive" id="avgRMultiple">0.00R</div>
                            </div>
                            <div class="metric-card">
                                <label>기대값</label>
                                <div class="value" id="expectancy">0.00</div>
                            </div>
                            <div class="metric-card">
                                <label>수익 거래</label>
                                <div class="value text-positive" id="positiveRCount">0</div>
                            </div>
                            <div class="metric-card">
                                <label>손실 거래</label>
                                <div class="value text-negative" id="negativeRCount">0</div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="rMultipleChart" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 섹터 노출 -->
                <div class="glass-card fade-in stagger-4">
                    <div class="glass-card-header">
                        <h3><i class="bi bi-pie-chart"></i>섹터 노출</h3>
                    </div>
                    <div class="glass-card-body">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-6);">
                            <div class="chart-container">
                                <canvas id="sectorChart" height="200"></canvas>
                            </div>
                            <div id="sectorList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 포지션별 리스크 -->
        <div class="glass-card fade-in stagger-5">
            <div class="glass-card-header">
                <h3><i class="bi bi-table"></i>포지션별 리스크</h3>
            </div>
            <div class="glass-card-body" style="padding: 0;">
                <div style="overflow-x: auto;">
                    <table class="glass-table">
                        <thead>
                            <tr>
                                <th>종목</th>
                                <th class="text-right">수량</th>
                                <th class="text-right">진입가</th>
                                <th class="text-right">현재가</th>
                                <th class="text-right">손절가</th>
                                <th class="text-right">미실현 손익</th>
                                <th class="text-right">리스크 금액</th>
                                <th class="text-right">현재 R</th>
                            </tr>
                        </thead>
                        <tbody id="positionRisksBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: var(--space-8); color: var(--text-muted);">
                                    <div class="spinner" style="width: 24px; height: 24px; display: inline-block; margin-right: var(--space-2);"></div>
                                    로딩 중...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- 설정 모달 -->
    <div class="modal-glass" id="settingsModal">
        <div class="modal-glass-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="bi bi-gear"></i>리스크 설정</h3>
                <button type="button" class="modal-close" onclick="closeGlassModal('settingsModal')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                    <form id="settingsForm">
                        <div class="form-group">
                            <label class="form-label">계좌 자본금</label>
                            <div style="display: flex; gap: var(--space-2);">
                                <span style="padding: var(--space-3) var(--space-4); background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-md); color: var(--text-secondary);">₩</span>
                                <input type="number" class="form-input" id="settingCapital" step="1000" style="flex: 1;">
                            </div>
                        </div>
                        <div style="height: 1px; background: var(--glass-border); margin: var(--space-5) 0;"></div>
                        <h6 style="margin-bottom: var(--space-4); color: var(--text-primary);">리스크 한도</h6>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-4); margin-bottom: var(--space-5);">
                            <div class="form-group">
                                <label class="form-label">거래당 최대 리스크 (%)</label>
                                <input type="number" class="form-input" id="settingMaxRiskPerTrade" step="0.1" min="0.1" max="10">
                            </div>
                            <div class="form-group">
                                <label class="form-label">일일 최대 손실 (%)</label>
                                <input type="number" class="form-input" id="settingMaxDailyLoss" step="0.1" min="1" max="20">
                            </div>
                            <div class="form-group">
                                <label class="form-label">주간 최대 손실 (%)</label>
                                <input type="number" class="form-input" id="settingMaxWeeklyLoss" step="0.1" min="2" max="30">
                            </div>
                            <div class="form-group">
                                <label class="form-label">최대 오픈 포지션 수</label>
                                <input type="number" class="form-input" id="settingMaxPositions" min="1" max="100">
                            </div>
                        </div>
                        <div style="height: 1px; background: var(--glass-border); margin: var(--space-5) 0;"></div>
                        <h6 style="margin-bottom: var(--space-4); color: var(--text-primary);">집중도 한도</h6>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-4); margin-bottom: var(--space-5);">
                            <div class="form-group">
                                <label class="form-label">최대 포지션 크기 (%)</label>
                                <input type="number" class="form-input" id="settingMaxPositionSize" step="1" min="5" max="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">섹터 집중도 한도 (%)</label>
                                <input type="number" class="form-input" id="settingMaxSectorConc" step="1" min="10" max="100">
                            </div>
                        </div>
                        <div style="height: 1px; background: var(--glass-border); margin: var(--space-5) 0;"></div>
                        <h6 style="margin-bottom: var(--space-4); color: var(--text-primary);">Kelly Criterion</h6>
                        <div class="form-group">
                            <label class="form-label">Kelly 비율 (0.5 = Half Kelly)</label>
                            <input type="number" class="form-input" id="settingKellyFraction" step="0.1" min="0.1" max="1">
                        </div>
                    </form>
                </div>
            <div class="modal-footer">
                <button type="button" class="btn-glass" onclick="closeGlassModal('settingsModal')">취소</button>
                <button type="button" class="btn-glass primary" onclick="saveSettings()">저장</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="utils.js"></script>
    <script src="auth.js"></script>
    <script src="js/glass-utils.js"></script>
    <script src="js/navigation-glass.js"></script>
    <script src="js/theme-toggle.js"></script>
    <script src="risk.js"></script>
</body>
</html>
